Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04

%post -c /bin/bash

    # Enable error handling
    set -euxo pipefail

    # Update apt-get and install necessary packages
    apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
        curl \
        terminator \
        tmux \
        vim \
        libsm6 \
        libxext6 \
        libxrender-dev \
        gedit \
        git \
        openssh-client \
        unzip \
        htop \
        libopenni-dev \
        apt-utils \
        usbutils \
        dialog \
        python3-venv \
        python3-dev \
        python3-pip \
        ffmpeg \
        nvidia-settings \
        libffi-dev \
        flex \
        bison \
        build-essential \
        wget \
        pciutils \
        mesa-utils \
        xserver-xorg \
        xserver-xorg-video-fbdev \
        xauth \
        xvfb \
        x11vnc

    apt-get remove -y python3-blinker

    # Clean up unnecessary files after installation
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # Set up Python environment
    # python3 -m virtualenv --python=/usr/bin/python3 /user_software/alfred_env
    # source /user_software/alfred_env/bin/activate

    # Install Python requirements
    pip install --upgrade pip
    pip install -U setuptools
    pip install -r /user_software/requirements.txt    
    rm -rf /user_software

%files
    # Copy requirements into the container
    requirements.txt /user_software/requirements.txt

%environment
    # Set environment variables for the runtime
    # export VIRTUAL_ENV=/user_software/alfred_env
    export PATH="$VIRTUAL_ENV/bin:$PATH"
    # export ALFRED_ROOT=/home/${USER_NAME}/alfred
    export DISPLAY=:0  # Set DISPLAY variable for Xvfb
    # source /user_software/alfred_env/bin/activate
    
%runscript
    # Activate virtual environment and execute bash
    # source /user_software/alfred_env/bin/activate
    
    # Execute the provided command or default to bash
    if [ "$#" -eq 0 ]; then
        exec /bin/bash
    else
        exec "$@"
    fi

